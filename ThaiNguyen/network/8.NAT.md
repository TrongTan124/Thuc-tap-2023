# Network address translation (NAT)
## Định nghĩa
NAT là một quy trình chuyển đổi private IP thành public IP. Điều này cho phép nhiều thiết bị có thể truy cập vào mạng qua 1 địa chỉ public IP. Việc này còn giúp giải quyết vấn đề bị hết địa chỉ IPv4. Cơ chế NAT thường hoạt động trên router hoặc firewall.

## NAT table
- là một bảng chứa địa chỉ IP private và số port của từng thiết bị liên kết cũng như địa chỉ IP public và số port chỉ định tương ứng. Bảng này sẽ được lưu ở trên router.

Bảng này thường có các mục như sau:
|Mục|Mô tả|
|---|---|
|source IP address| địa chỉ private IP của gói tin|
|source port number| số port gốc của gói tin|
|Destination IP address| địa chỉ IP public của server tại điểm đến |
|Destination port number| số port của server tại điểm đến |
|Translate source IP address| địa chỉ IP public được gán cho gói tin bởi router|
|Translated source port number| số port độc nhất được gán cho gói tin bởi router|
|Translation protocol| cho biết giao thức được dùng để truyền gói tin, ví dụ như UDP, TCP,..|
|Timestamp| chứa thông tin về thời gian địa chỉ IP này được thêm vào bảng, cũng như khoảng thời gian mà địa chỉ IP này hợp lệ trước khi timeout( khoảng thời gian này còn được gọi là timeout period)|

Khi một thiết bị trong local network tạo kết nối với một server bên ngoài network đó, các dữ liệu về địa chỉ IP của thiết bị đó và server tại điểm đến sẽ được thêm vào theo các mục trên.

Các thông tin trên NAT table sẽ được cập nhật liên tục. Nếu một liên kết tương ứng với một mục trên bảng không hoạt động trong sau khi timeout period hoặc một liên kết bị ngắt, mục tương ứng với liên kết đó sẽ bị xóa khỏi bảng.


## Cách hoạt động
### chuyển gói tin từ thiết bị trong local network đến server qua internet(Source NAT): 
- khi một thiết bị trong một hệ thống mạng muốn kết nối với một server qua internet, nó sẽ gửi một packet có bao gồm địa chỉ private IP và số source port của thiết bị đó. Ngoài ra, packet đó còn bao gồm địa chỉ public IP và số port của bên nhận. 
- router sẽ duy trì một NAT table ( bảng NAT) có chứa các liên kết đang hoạt động và IP chuyển đổi tương ứng của chúng. Router sẽ tham chiếu bảng này để tìm ra địa chỉ public IP tương ứng. Nếu chưa có, router sẽ thay địa chỉ IP private của packet bằng địa chỉ IP public của nó, và sẽ chỉ định một số port độc nhất cho packet này. Dữ liệu này cũng sẽ được lưu vào NAT table.
- router sẽ chuyển tiếp gói này, với địa chỉ IP public đã được chuyển đổi của nó, tới đích đến dựa trên địa chỉ public IP đến và số port của điểm đến.
- server tại điểm đến sẽ nhận gói tin và xử lý chúng

### chuyển gói tin từ server quay trở lại thiết bị trong local network qua internet(Destination NAT)

- khi gửi lại gói tin, server sẽ gửi lại cho router thông qua địa chỉ public IP và số port được chỉ định từ trước trên gói tin
- khi router nhận được gói tin, nó sẽ tiến hành tra cứu NAT table dựa trên địa chỉ public IP và số port độc nhất trên gói tin để tìm ra địa chỉ IP private và số port ban đầu của gói tin đó. 
- Router sẽ thay địa chỉ public IP đích và số port chỉ định với địa chỉ IP private và số port ban đầu dựa trên việc tra cứu NAT table 
- Cuối cùng, dựa trên địa chỉ private IP và số port gốc trên gói tin sau khi đã được thay, gói tin sẽ được chuyển về thiết bị tương ứng
### Port address translation (PAT) or NAT overload
- đây là quá trình chuyển đổi số port khi chuyển một gói tin từ local network đến một server ngoài network đó và ngược lại, như đã được mô tả ở phía trên.
- điều này giúp cho nhiều thiết bị từ một local network có thể truy cập internet bằng một địa chỉ IP public
Cụ thể như sau:
- packet được gửi từ một thiết bị trong local network có chứa số port gốc của thiết bị gửi. 
- khi được gửi đến router, ngoài việc chuyển đổi địa chỉ IP từ private thành public như trên, số port gốc sẽ được thay bằng một số port độc nhất được chỉ định bởi router. 
- gói tin sẽ được chuyển đến điểm đến bằng địa chỉ IP public và số port đã được chuyển đổi
- khi packet được gửi lại từ server về local network dựa trên public IP và số port chỉ định, router sẽ nhận packet, tra cứu địa chỉ IP public và số port chỉ định để tìm ra private IP và số port gốc tương ứng
- địa chỉ IP private và số port gốc sẽ được thay vào packet header và packet sẽ được chuyển từ router đến thiết bị tương ứng với dữ liệu trên

## Static NAT
 NAT tĩnh là một kỹ thuật ánh xạ một-một để dịch các địa chỉ IP private cụ thể sang các địa chỉ IP public tương ứng. Với static NAT, các bộ định tuyến dịch một địa chỉ IP private thành một địa chỉ IP public duy nhất bằng NAT table bằng cách đối chiếu private IP đó với các ánh xạ(mapping) đã được định sẵn. Ánh xạ giữa IP private và IP public được định cấu hình theo cách thủ công và duy trì cố định cho đến khi quản trị viên mạng sửa đổi hoặc xóa.
 
 ![picstatic](images/static_NAT.png)
 
## Dynamic NAT
Dynamic NAT là một quá trình trong đó các địa chỉ IP private được dịch bằng cách phân bổ động các địa chỉ IP public từ nhóm địa chỉ IP public có sẵn. Các bộ định tuyến sẽ tự động ánh xạ một địa chỉ IP private từ một gói mà nó nhận được sang một địa chỉ IP public trong nhóm có sẵn của nó và thêm mục nhập đó vào bảng NAT. Nếu kết nối giữa 1 mapping kết thúc hoặc hết thời gian chờ(timeout), địa chỉ IP public cho mục nhập đó sẽ được giải phóng trở lại nhóm IP, cho phép sử dụng lại địa chỉ đó.

![dynamicNAT](images/dynamic_NAT.png)



# Cơ chế DNS

## Nguồn tham khảo
1. [Nguồn 1](https://www.tutorialspoint.com/what-is-the-difference-between-snat-and-dnat#:~:text=SNAT%20transforms%20the%20source%20address,the%20routing%20decision%20is%20built.)
2. [Nguồn 2](https://devopscube.com/what-is-nat-how-does-nat-work/)
3. [Nguồn 3](https://www.practicalnetworking.net/series/nat/dynamic-nat/)





